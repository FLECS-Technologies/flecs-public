# Copyright 2021 FLECS Technologies GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# forward build to Docker if DOCKERLESS is not set
ifndef DOCKERLESS
DOCKERARGS=-e DOCKERLESS=1 -e MAKEFLAGS="$(MAKEFLAGS)"
endif
%/all:
	$(DOCKER_PREFIX) $(MAKE) -C $(ROOT_DIR)/$* all
%/archive:
	$(DOCKER_PREFIX) $(MAKE) -C $(ROOT_DIR)/$* archive
%/binary:
	$(DOCKER_PREFIX) $(MAKE) -C $(ROOT_DIR)/$* binary
%/lib:
	$(DOCKER_PREFIX) $(MAKE) -C $(ROOT_DIR)/$* lib
%/package:
	$(DOCKER_PREFIX) $(MAKE) -C $(ROOT_DIR)/$* package
%/docker:
	$(MAKE) -C $(ROOT_DIR)/$* docker

# generic rule for building objects from source files
$(OUT)/%.o: src/%.cpp
	@mkdir -p $(shell readlink -m $(shell dirname $@))
	$(CXX) -c $(CXXFLAGS) -I $(ROOT_DIR) $(INCLUDE) -o $@ $<

# generic rule to build binary from objects, if set
ifdef BINARY
$(OUT)/$(BINARY): INCLUDE := $(INCLUDE_BINARY)
$(OUT)/$(BINARY): $(DEPENDS_BINARY) $(OBJ_BINARY) $(HEADER_BINARY)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJ_BINARY) $(STATIC_LIBS_BINARY) $(DYNAMIC_LIBS_BINARY)

.PHONY: binary
binary: $(OUT)/$(BINARY)

ALL += binary
endif

# generic rule to build archive from objects, if set
ifdef ARCHIVE
$(OUT)/$(ARCHIVE): INCLUDE := $(INCLUDE_ARCHIVE)
$(OUT)/$(ARCHIVE): $(DEPENDS_ARCHIVE) $(OBJ_ARCHIVE) $(HEADER_ARCHIVE)
	$(AR) cr $@ $(OBJ_ARCHIVE)

.PHONY: archive
archive: $(OUT)/$(ARCHIVE)

ALL += archive
endif

# generic rule to build lib from objects, if set
ifdef LIB
$(OUT)/$(LIB): INCLUDE := $(INCLUDE_LIB)
$(OUT)/$(LIB): CXXFLAGS += -shared -fPIC
$(OUT)/$(LIB): $(DEPENDS_LIB) $(OBJ_LIB) $(HEADER_LIB)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJ_LIB) $(STATIC_LIBS_LIB) $(DYNAMIC_LIBS_LIB)

.PHONY: lib
lib: $(OUT)/$(LIB)

ALL += lib
endif

# generic "all" rule - builds BINARY, LIB and ARCHIVE, if set
.PHONY: all
all: $(ALL)

# generic "deb-pkg" rule to build .deb package from artifacts
ifdef DEB_PKG
$(OUT)/$(DEB_PKG): all deb-pkg-prepare
	@rm -rf $(OUT)/debian;
	@mkdir -p $(shell readlink -m $(shell dirname $@))
	@cp -r debian $(OUT)/debian;
	@echo BINARY: $(BINARY);
	@if [ ! -z "$(BINARY)" ]; then \
		mkdir -p $(OUT)/debian/usr/bin; \
		cp -pf $(OUT)/$(BINARY) $(OUT)/debian/usr/bin; \
	fi;
	@if [ ! -z "$(ARCHIVE)" ]; then \
		mkdir -p $(OUT)/debian/usr/lib; \
		cp -pf $(OUT)/$(ARCHIVE) $(OUT)/debian/usr/lib; \
	fi;
	@if [ "$(MACHINE)" = "x86_64-linux-gnu" ]; then \
		ARCH=amd64; \
	elif [ "$(MACHINE)" = "arm-linux-gnueabihf" ]; then \
		ARCH=armhf; \
	elif [ "$(MACHINE)" = "aarch64-linux-gnu" ]; then \
		ARCH=arm64; \
	else \
		echo "Unknown architecture for $(MACHINE)"; \
	fi; \
	sed -i "s/##ARCH##/$${ARCH}/g" $(OUT)/debian/DEBIAN/control;
	sed -i "s/##PACKAGE##/$(PACKAGE)/g" $(OUT)/debian/DEBIAN/*;
	sed -i "s/##VERSION##/$(VERSION)/g" $(OUT)/debian/DEBIAN/*;
	@dpkg-deb --root-owner-group -Z gzip --build $(OUT)/debian $(OUT)/$(DEB_PKG)

.PHONY: deb-pkg
deb-pkg: $(OUT)/$(DEB_PKG)

# allows targets additional preparation steps before packaging
.PHONY: deb-pkg-prepare

PACKAGES += deb-pkg
endif

ifndef NDEBUG
DOCKER_TAG := develop
else
DOCKER_TAG := latest
endif

ifdef DOCKER_IMAGE
.PHONY: docker
docker: docker-prepare
	docker build --build-arg MACHINE=$(MACHINE) -t $(DOCKER_IMAGE):$(DOCKER_TAG) .

.PHONY: docker-prepare
endif

# generic "package" rule to build all available packages
.PHONY: package
package: $(PACKAGES)

# generic "clean" rule - remove $(OUT) directory
.PHONY: clean
clean:
	@rm -rf $(OUT)
