#!/bin/bash

CHANNEL=latest

if [ -f /etc/flecs.d/channel ]; then
    CHANNEL=$(cat /etc/flecs.d/channel);
fi

dpkg -s wget >/dev/null 2>&1 || (export DEBIAN_FRONTEND=noninteractive && apt -y update && apt -yq install wget)
if [ "${CHANNEL}" = "latest" ]; then
    wget -q -P /tmp/ https://marketplace.flecs.tech/deb/flecs-webapp.deb
else
    wget -q -P /tmp/ https://marketplace.flecs.tech:8443/deb/flecs-webapp.deb
fi

MD5_INSTALLED=$(cat /var/lib/flecs-updater/flecs-webapp.installed 2>/dev/null)
MD5_DOWNLOADED=($(md5sum /tmp/flecs-webapp.deb 2>/dev/null))

if [ "${MD5_DOWNLOADED}" != "" ] && [ "${MD5_DOWNLOADED}" != "${MD5_INSTALLED}" ]; then
    echo new: "${MD5_DOWNLOADED}"
    echo old: "${MD5_INSTALLED}"
    dpkg -i /tmp/flecs-webapp.deb
    if [ $? -eq 0 ]; then
        mkdir -p /var/lib/flecs-updater/
        echo ${MD5_DOWNLOADED} >/var/lib/flecs-updater/flecs-webapp.installed
    fi
fi

docker login --username flecs --password $(echo "YzMwMDZmMmYtZWM1My00ZjE5LWEyMjAtYzIyZjZkYjU1OTk1" | base64 -d) >/dev/null
docker pull flecs/updater:${CHANNEL} | grep "Downloaded newer image"
if [ ! $? -eq 0 ]; then
    exit 0;
fi

/usr/bin/docker run --rm -v /usr/bin:/host/usr/bin flecs/updater:${CHANNEL} || exit 1

DIR=$(dirname $(readlink -f ${0}))

cd ${DIR}

# extract new packages
for f in flecs*.tar.gz; do
    tar xf "${f}" && rm "${f}" || exit 1;
done

# install new packages
for f in flecs*.deb; do
    dpkg --install "${f}" && rm "${f}" || exit 1;
done
