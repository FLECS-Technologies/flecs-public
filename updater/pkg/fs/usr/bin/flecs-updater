#!/bin/bash

CHANNEL=latest

if [ -f /etc/flecs.d/channel ]; then
    CHANNEL=$(cat /etc/flecs.d/channel);
fi

docker login --username flecs --password $(echo "YzMwMDZmMmYtZWM1My00ZjE5LWEyMjAtYzIyZjZkYjU1OTk1" | base64 -d) >/dev/null
docker pull flecs/updater:${CHANNEL} | grep "Downloaded newer image"
if [ ! $? -eq 0 ]; then
    exit 0;
fi

/usr/bin/docker run --rm -v /usr/bin:/host/usr/bin flecs/updater:${CHANNEL} || exit 1

DIR=$(dirname $(readlink -f ${0}))

cd ${DIR}

# extract new packages
for f in flecs*.tar.gz; do
    tar xf "${f}" && rm "${f}" || exit 1;
done

# install new packages
for f in flecs*.deb; do
    dpkg --install "${f}" && rm "${f}" || exit 1;
done
